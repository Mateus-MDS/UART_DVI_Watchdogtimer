/**
 * Biblioteca para controle IR com DMA
 * Versão SIMPLES - baseada no exemplo de fade com DMA
 */

#include "pico/stdlib.h"
#include "stdio.h"
#include "hardware/pwm.h"
#include "hardware/gpio.h"
#include "hardware/dma.h"

// Definições
#define IR_CARRIER_FREQ 38000

// Variáveis globais PWM e DMA
static uint pwm_slice;
static uint pwm_channel;
static bool ir_initialized = false;
static int dma_channel = -1;

// Buffer para níveis PWM (ON/OFF)
#define MAX_PWM_BUFFER 2048
static uint16_t pwm_levels[MAX_PWM_BUFFER];
static uint32_t pwm_count = 0;

// ============================================================================
// SINAIS IR (mantidos do código original)
// ============================================================================

static const uint16_t rawSignal_off[] = {
    3603, 1758, 360, 1359, 404, 1362, 405, 344, 423, 352, 426, 348, 
    404, 1335, 429, 345, 427, 348, 413, 1338, 404, 1361, 404, 345, 
    427, 1312, 429, 345, 426, 348, 421, 1319, 428, 1335, 362, 426, 
    406, 1334, 403, 1333, 405, 345, 427, 347, 408, 1358, 403, 344, 
    407, 368, 390, 1361, 403, 373, 426, 349, 403, 372, 410, 364, 
    426, 349, 427, 347, 427, 348, 391, 423, 406, 345, 425, 349, 
    426, 348, 426, 349, 404, 370, 403, 372, 411, 364, 413, 401, 
    406, 343, 426, 349, 427, 348, 403, 371, 412, 1354, 403, 344, 
    426, 349, 415, 399, 405, 344, 403, 372, 403, 1338, 427, 1334, 
    404, 345, 404, 371, 414, 360, 416, 1336, 403, 1362, 404, 1333, 
    406, 343, 413, 363, 410, 364, 402, 373, 426, 349, 415, 399, 
    404, 345, 403, 372, 404, 1336, 427, 1335, 404, 1334, 404, 345, 
    403, 372, 415, 399, 405, 344, 403, 372, 403, 372, 402, 372, 
    402, 373, 402, 373, 402, 372, 416, 398, 405, 345, 427, 348, 
    425, 350, 426, 348, 427, 348, 427, 348, 428, 347, 415, 398, 
    381, 394, 381, 394, 380, 394, 380, 395, 380, 395, 378, 396, 
    378, 397, 398, 391, 352, 423, 352, 422, 352, 423, 376, 399, 
    379, 395, 383, 392, 383, 392, 399, 367, 405, 370, 404, 1331, 
    402, 1336, 401, 376, 401, 373, 401, 374, 399, 1337, 414
};

static const uint16_t rawSignal_on[] = {
    3585, 1762, 354, 1393, 411, 1328, 413, 342, 392, 383, 364, 411, 
    388, 1369, 409, 346, 365, 410, 445, 1326, 414, 1324, 412, 344, 
    389, 1368, 408, 347, 366, 409, 365, 1393, 408, 1329, 386, 384, 
    364, 1393, 410, 1329, 409, 346, 364, 411, 364, 1392, 386, 370, 
    365, 410, 444, 1327, 410, 346, 363, 412, 363, 412, 363, 411, 
    364, 410, 364, 411, 364, 411, 442, 347, 364, 410, 365, 410, 
    363, 411, 391, 384, 364, 411, 365, 410, 363, 411, 447, 342, 
    365, 410, 364, 1392, 409, 348, 364, 410, 390, 1366, 410, 347, 
    391, 384, 444, 1326, 411, 1327, 412, 344, 395, 380, 395, 1361, 
    410, 347, 394, 381, 395, 379, 446, 1324, 384, 1353, 391, 367, 
    399, 1356, 411, 347, 398, 377, 400, 374, 401, 374, 444, 344, 
    402, 1353, 414, 344, 403, 372, 403, 372, 429, 1325, 415, 345, 
    429, 349, 439, 362, 413, 361, 416, 368, 403, 372, 380, 394, 
    379, 396, 378, 397, 376, 399, 390, 377, 402, 369, 401, 398, 
    378, 374, 400, 374, 399, 375, 399, 375, 396, 380, 407, 381, 
    390, 384, 366, 409, 364, 411, 365, 409, 366, 409, 386, 388, 
    389, 386, 378, 411, 364, 411, 363, 412, 362, 412, 363, 412, 
    364, 410, 364, 411, 363, 412, 375, 1396, 343, 413, 360, 414, 
    361, 1396, 343, 1396, 342, 1396, 340, 1398, 340, 416, 368
};

static const uint16_t temp_para_22[] = {
    3609, 1760, 381, 1338, 403, 1363, 404, 344, 404, 371, 403, 372, 
    404, 1336, 427, 345, 403, 372, 415, 1335, 404, 1362, 405, 344, 
    404, 1360, 404, 344, 404, 371, 403, 1362, 403, 1334, 389, 399, 
    405, 1313, 425, 1334, 405, 344, 403, 372, 403, 1361, 404, 344, 
    403, 372, 419, 1334, 428, 346, 402, 372, 403, 372, 403, 372, 
    403, 372, 402, 372, 403, 372, 419, 372, 427, 345, 403, 372, 
    402, 372, 403, 372, 403, 372, 402, 372, 403, 373, 419, 370, 
    428, 345, 404, 1361, 404, 344, 403, 372, 423, 1341, 404, 346, 
    428, 318, 444, 1338, 428, 1334, 403, 370, 381, 394, 380, 1333, 
    405, 1333, 403, 397, 354, 421, 361, 1365, 400, 400, 353, 422, 
    377, 1336, 399, 401, 382, 393, 381, 394, 383, 392, 393, 371, 
    405, 1331, 404, 373, 403, 372, 402, 1333, 403, 374, 400, 375, 
    398, 376, 410, 379, 396, 378, 394, 381, 392, 383, 389, 385, 
    391, 384, 391, 384, 392, 382, 379, 410, 390, 385, 364, 411, 
    363, 411, 363, 412, 365, 410, 389, 386, 362, 413, 375, 414, 
    360, 414, 362, 414, 361, 414, 359, 416, 358, 435, 340, 435, 
    340, 438, 350, 436, 338, 437, 337, 437, 337, 438, 337, 438, 
    336, 439, 335, 440, 335, 482, 306, 1404, 333, 1406, 331, 1432, 
    306, 445, 329, 470, 305, 445, 330, 469, 305, 1444, 303
};

static const uint16_t temp_para_20[] = {
    3611, 1759, 364, 1356, 428, 1314, 428, 344, 427, 317, 461, 300, 
    474, 1308, 430, 345, 427, 349, 421, 1327, 405, 1339, 428, 344, 
    412, 1326, 428, 346, 427, 348, 427, 1311, 430, 1312, 386, 424, 
    406, 1308, 429, 1311, 428, 344, 403, 371, 427, 1312, 429, 345, 
    410, 364, 417, 1334, 404, 373, 422, 352, 427, 348, 428, 347, 
    426, 349, 427, 347, 427, 348, 392, 422, 405, 345, 428, 346, 
    428, 346, 427, 348, 427, 349, 426, 347, 410, 365, 417, 397, 
    406, 344, 428, 1311, 429, 344, 403, 372, 427, 1311, 429, 345, 
    403, 373, 415, 1336, 429, 1336, 403, 345, 404, 372, 404, 1337, 
    426, 1334, 404, 346, 404, 396, 399, 1325, 429, 1311, 429, 371, 
    377, 1335, 405, 395, 353, 422, 351, 423, 352, 424, 400, 388, 
    383, 1329, 400, 401, 385, 389, 386, 1326, 402, 400, 385, 389, 
    409, 345, 446, 341, 403, 370, 406, 370, 404, 369, 404, 371, 
    402, 373, 401, 373, 401, 373, 443, 349, 396, 376, 395, 380, 
    393, 382, 390, 384, 391, 384, 392, 383, 392, 383, 379, 430, 
    370, 384, 364, 410, 362, 413, 363, 412, 367, 408, 389, 386, 
    361, 414, 378, 430, 342, 433, 342, 415, 360, 433, 340, 434, 
    340, 435, 339, 435, 340, 438, 350, 1399, 338, 438, 337, 437, 
    337, 1401, 337, 439, 335, 440, 335, 440, 334, 1439, 307
};

static const uint16_t fan_1[] = {
    3612, 1760, 430, 1315, 426, 1288, 446, 353, 426, 349, 426, 349, 
    426, 1284, 449, 354, 425, 350, 433, 1319, 424, 1286, 449, 353, 
    426, 1285, 448, 353, 427, 349, 425, 1285, 448, 1290, 462, 354, 
    426, 1286, 448, 1289, 448, 354, 426, 349, 425, 1285, 447, 356, 
    426, 349, 434, 1317, 424, 351, 426, 349, 425, 349, 426, 349, 
    426, 349, 425, 350, 425, 350, 435, 353, 425, 350, 424, 350, 
    425, 350, 425, 349, 425, 350, 425, 350, 424, 351, 436, 353, 
    425, 349, 424, 1287, 353, 449, 422, 353, 422, 1287, 375, 428, 
    420, 355, 437, 1315, 351, 1360, 373, 429, 415, 359, 418, 1293, 
    374, 1364, 373, 429, 384, 391, 438, 351, 416, 1294, 376, 426, 
    379, 1332, 376, 426, 353, 422, 354, 420, 378, 397, 439, 350, 
    382, 1328, 398, 405, 352, 422, 353, 1358, 399, 403, 353, 421, 
    354, 421, 439, 350, 380, 394, 376, 399, 353, 422, 353, 421, 
    379, 396, 353, 422, 353, 422, 438, 351, 380, 394, 378, 397, 
    376, 398, 378, 397, 377, 398, 377, 397, 379, 396, 437, 352, 
    380, 394, 380, 395, 378, 397, 379, 395, 381, 394, 382, 393, 
    384, 390, 434, 355, 413, 362, 413, 361, 414, 360, 416, 359, 
    415, 360, 416, 358, 417, 358, 427, 362, 417, 357, 417, 358, 
    417, 1295, 439, 362, 415, 361, 414, 338, 434, 1299, 449
};

static const uint16_t fan_2[] = {
    3612, 2002, 181, 1323, 419, 1292, 447, 353, 420, 354, 421, 354, 
    420, 1320, 421, 352, 420, 2108, 420, 1291, 448, 353, 420, 1319, 
    421, 353, 419, 354, 421, 1319, 421, 2105, 419, 1321, 420, 1290, 
    448, 353, 419, 355, 420, 1320, 421, 353, 419, 2108, 421, 353, 
    420, 355, 420, 354, 420, 355, 420, 354, 421, 355, 420, 1142, 
    419, 357, 419, 355, 420, 355, 420, 355, 419, 356, 419, 355, 
    420, 1142, 421, 355, 420, 1295, 445, 353, 420, 355, 419, 1294, 
    447, 353, 420, 2106, 422, 1289, 449, 353, 420, 355, 419, 1292, 
    449, 1288, 451, 352, 419, 649, 121, 373, 420, 1294, 448, 352, 
    420, 1290, 451, 351, 421, 354, 420, 355, 420, 355, 429, 1323, 
    422, 1288, 451, 352, 420, 354, 421, 1289, 452, 351, 421, 353, 
    422, 354, 430, 358, 421, 354, 421, 353, 423, 352, 422, 353, 
    421, 354, 422, 352, 422, 353, 431, 357, 422, 353, 423, 352, 
    423, 351, 423, 352, 424, 351, 423, 351, 424, 351, 434, 355, 
    425, 350, 425, 349, 426, 349, 425, 350, 425, 349, 425, 350, 
    425, 350, 437, 351, 426, 349, 425, 349, 426, 349, 424, 351, 
    423, 273, 500, 268, 506, 270, 514, 1295, 446, 354, 420, 354, 
    421, 1293, 445, 353, 420, 354, 421, 354, 422, 1293, 452
};

// ============================================================================
// CONVERSÃO: Sinal RAW ? Buffer PWM
// ============================================================================

bool prepare_pwm_buffer(const uint16_t* raw_signal, size_t raw_length) {
    pwm_count = 0;
    uint16_t pwm_wrap = pwm_hw->slice[pwm_slice].top;
    uint16_t pwm_on = pwm_wrap / 2;   // 50% duty = carrier ON
    uint16_t pwm_off = 0;              // 0% duty = carrier OFF
    
    for (size_t i = 0; i < raw_length && pwm_count < MAX_PWM_BUFFER; i++) {
        uint16_t duration_us = raw_signal[i];
        bool is_on = (i % 2 == 0);  // Par=ON, Ímpar=OFF
        
        // Cada ~26us = 1 ciclo PWM em 38kHz
        uint16_t num_cycles = duration_us / 26;
        if (num_cycles < 1) num_cycles = 1;
        
        uint16_t level = is_on ? pwm_on : pwm_off;
        
        for (uint16_t j = 0; j < num_cycles && pwm_count < MAX_PWM_BUFFER; j++) {
            pwm_levels[pwm_count++] = level;
        }
    }
    
    return pwm_count > 0;
}

// ============================================================================
// INICIALIZAÇÃO
// ============================================================================

bool custom_ir_init(uint gpio_pin) {
    // Configurar PWM
    gpio_set_function(gpio_pin, GPIO_FUNC_PWM);
    pwm_slice = pwm_gpio_to_slice_num(gpio_pin);
    pwm_channel = pwm_gpio_to_channel(gpio_pin);
    
    pwm_config config = pwm_get_default_config();
    pwm_config_set_clkdiv(&config, 1.0f);
    
    // Para 38kHz: 125MHz / 38kHz ? 3289
    uint16_t wrap_value = (125000000 / IR_CARRIER_FREQ) - 1;
    pwm_config_set_wrap(&config, wrap_value);
    
    pwm_init(pwm_slice, &config, true);
    pwm_set_chan_level(pwm_slice, pwm_channel, 0);  // Começa desligado
    
    // Configurar DMA
    dma_channel = dma_claim_unused_channel(true);
    
    dma_channel_config c = dma_channel_get_default_config(dma_channel);
    channel_config_set_transfer_data_size(&c, DMA_SIZE_16);
    channel_config_set_read_increment(&c, true);    // Lê do buffer sequencialmente
    channel_config_set_write_increment(&c, false);  // Sempre escreve no mesmo reg PWM
    channel_config_set_dreq(&c, DREQ_PWM_WRAP0 + pwm_slice);  // Sincroniza com PWM
    
    dma_channel_configure(
        dma_channel,
        &c,
        &pwm_hw->slice[pwm_slice].cc,  // Escreve no registrador CC do PWM
        NULL,   // Origem será definida depois
        0,      // Contagem será definida depois
        false   // Não inicia ainda
    );
    
    ir_initialized = true;
    
    printf("IR DMA inicializado: PWM slice=%d, DMA chan=%d\n", pwm_slice, dma_channel);
    
    return true;
}

// ============================================================================
// ENVIO COM DMA
// ============================================================================

void send_raw_signal(const uint16_t* signal, size_t length) {
    if (!ir_initialized) {
        printf("ERRO: IR não inicializado!\n");
        return;
    }
    
    // Preparar buffer PWM
    if (!prepare_pwm_buffer(signal, length)) {
        printf("ERRO: Falha ao preparar buffer\n");
        return;
    }
    
    printf("Transmitindo %lu valores PWM via DMA...", pwm_count);
    
    // Configurar e iniciar DMA
    dma_channel_set_read_addr(dma_channel, pwm_levels, false);
    dma_channel_set_trans_count(dma_channel, pwm_count, true);  // true = inicia
    
    // Aguardar conclusão
    dma_channel_wait_for_finish_blocking(dma_channel);
    
    // Desligar PWM
    pwm_set_chan_level(pwm_slice, pwm_channel, 0);
    
    printf(" OK!\n");
}

// ============================================================================
// FUNÇÕES PÚBLICAS (mantidas iguais)
// ============================================================================

void turn_off_ac() {
    printf("Comando: DESLIGAR AC\n");
    send_raw_signal(rawSignal_off, sizeof(rawSignal_off) / sizeof(uint16_t));
}

void turn_on_ac() {
    printf("Comando: LIGAR AC\n");
    send_raw_signal(rawSignal_on, sizeof(rawSignal_on) / sizeof(uint16_t));
}

void set_temp_22c() {
    printf("Comando: TEMPERATURA 22°C\n");
    send_raw_signal(temp_para_22, sizeof(temp_para_22) / sizeof(uint16_t));
}

void set_temp_20c() {
    printf("Comando: TEMPERATURA 20°C\n");
    send_raw_signal(temp_para_20, sizeof(temp_para_20) / sizeof(uint16_t));
}

void set_fan_level_1() {
    printf("Comando: VENTILADOR NÍVEL 1\n");
    send_raw_signal(fan_1, sizeof(fan_1) / sizeof(uint16_t));
}

void set_fan_level_2() {
    printf("Comando: VENTILADOR NÍVEL 2\n");
    send_raw_signal(fan_2, sizeof(fan_2) / sizeof(uint16_t));
}

void ir_demo() {
    printf("\n=== DEMONSTRAÇÃO IR COM DMA ===\n");
    
    turn_on_ac();
    sleep_ms(2000);
    
    set_temp_22c();
    sleep_ms(2000);
    
    set_fan_level_1();
    sleep_ms(2000);
    
    turn_off_ac();
    
    printf("=== Demonstração concluída! ===\n\n");
}